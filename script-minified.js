(async function(){function sleep(e){return new Promise(t=>setTimeout(t,e))}function detectCurrency(e){if(!e)return"";const t=e.match(/[€$£¥₽₹]/);if(t)return t[0];const n=e.replace(/[^A-Za-z]/g," ").trim();if(!n)return"";const r=n.split(/\s+/),o=r[r.length-1];return o&&o.length>=2&&o.length<=4?o.toUpperCase():""}function parsePrice(e){if(!e)return null;let t=e.replace(/[^\d.,]/g,"").trim();if(!t)return null;const n=t.includes("."),r=t.includes(",");if(r&&n){const e=t.lastIndexOf("."),n=t.lastIndexOf(",");t=n>e?t.replace(/\./g,"").replace(",","."):t.replace(/,/g,"")}else r&&!n?t=t.replace(",","."):t=t.replace(/,/g,"");const o=parseFloat(t);return Number.isFinite(o)?o:null}function getOrderYear(e){const t=e.querySelector(".order-item-header-right-info div");if(!t)return"Unknown";const n=t.innerText||"",r=n.match(/(\d{4})/);return r?r[1]:"Unknown"}function getProductInfo(e){const t=e.querySelector(".order-item-content-info-name a");return t?{title:(t.innerText||"").trim(),url:t.href||null}:{title:null,url:null}}async function loadAllOrders(){let e=0,t=0;for(;;){const n=document.querySelector(".order-more button"),r=n&&null!==n.offsetParent,o=document.querySelectorAll(".order-item").length;if(!n||!r||n.disabled)break;if(o===e){t++;if(t>=3)break}else t=0,e=o;n.click();await sleep(2e3)}await sleep(1500)}function summarizeOrders(){const e=document.querySelectorAll(".order-item"),t=[],n={};let r=0,o="";e.forEach(e=>{const a=e.querySelector(".order-item-content-opt-price-total");if(!a)return;const l=a.innerText||a.textContent||"";o||(o=detectCurrency(l));const c=parsePrice(l);if(null==c)return;const i=Number(c.toFixed(2)),u=getOrderYear(e),s=getProductInfo(e);n[u]=(n[u]||0)+i,r+=i,t.push({Year:u,Amount:i.toFixed(2),Currency:o,"Product title":s.title,"Product URL":s.url})});const a=Object.keys(n).sort().map(e=>({Year:e,"Total spent":n[e].toFixed(2),Currency:o}));return console.clear(),console.log("=== Orders ==="),console.table(t),console.log("=== Total spent per year ==="),console.table(a),console.log("=== Total spent overall ==="),console.log(r.toFixed(2)+" "+o),{rows:t,yearlyTable:a,grandTotal:r.toFixed(2),currency:o}}console.clear();await loadAllOrders();summarizeOrders()})();
